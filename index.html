<script>
  let trackOrder = [];
  let currentTrackIndex = -1; // To track the current playing index

  async function loadAlbumData() {
    try {
      const response = await fetch('data/album-data.json');
      if (!response.ok) throw new Error('Failed to fetch album data');
      const data = await response.json();

      // Update album info
      document.getElementById('album-cover').src = data.cover;
      document.getElementById('dialog-image').src = data.cover;
      document.getElementById('album-name').textContent = data.name;

      // Populate track table
      const trackTable = document.getElementById('track-table');
      const tracks = data.tracks;

      trackOrder = tracks; // Store the original order
      let totalSeconds = 0;

      tracks.forEach((track, index) => {
        const row = document.createElement('tr');
        row.setAttribute('data-track', track.file);
        row.innerHTML = `
          <td>${index + 1}</td>
          <td>${track.title}</td>
          <td>${formatDuration(track.duration)}</td>
        `;
        row.addEventListener('click', () => {
          currentTrackIndex = index; // Update the current track index
          playTrack(track.file, track.title);
        });
        trackTable.appendChild(row);

        totalSeconds += track.duration;
      });

      document.getElementById('album-info').textContent = `${data.year} · ${tracks.length} songs · ${formatDuration(totalSeconds)}`;
    } catch (error) {
      console.error('Error loading album data:', error);
    }
  }

  function formatDuration(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
  }

  function playTrack(file, title) {
    const audioPlayer = document.getElementById('audio-player');
    const currentTrackText = document.getElementById('current-track');

    audioPlayer.src = `tracks/${file}`;
    audioPlayer.play();
    currentTrackText.textContent = `Now Playing: ${title}`;
  }

  function playFirstTrack() {
    if (trackOrder.length > 0) {
      currentTrackIndex = 0; // Set to the first track
      const firstTrack = trackOrder[currentTrackIndex];
      playTrack(firstTrack.file, firstTrack.title);
    }
  }

  function playNextTrack() {
    if (trackOrder.length > 0 && currentTrackIndex < trackOrder.length - 1) {
      currentTrackIndex += 1; // Move to the next track
      const nextTrack = trackOrder[currentTrackIndex];
      playTrack(nextTrack.file, nextTrack.title);
    }
  }

  function playPreviousTrack() {
    if (trackOrder.length > 0 && currentTrackIndex > 0) {
      currentTrackIndex -= 1; // Move to the previous track
      const prevTrack = trackOrder[currentTrackIndex];
      playTrack(prevTrack.file, prevTrack.title);
    }
  }

  function shuffleTracks() {
    const shuffled = [...trackOrder].sort(() => Math.random() - 0.5);
    const trackTable = document.getElementById('track-table');
    trackTable.innerHTML = '';

    shuffled.forEach((track, index) => {
      const row = document.createElement('tr');
      row.setAttribute('data-track', track.file);
      row.innerHTML = `
        <td>${index + 1}</td>
        <td>${track.title}</td>
        <td>${formatDuration(track.duration)}</td>
      `;
      row.addEventListener('click', () => {
        currentTrackIndex = index; // Update the current track index
        playTrack(track.file, track.title);
      });
      trackTable.appendChild(row);
    });

    trackOrder = shuffled; // Update the global track order
    currentTrackIndex = -1; // Reset current track index since the order changed
  }

  function openDialog() {
    document.getElementById('dialog-overlay').style.display = 'flex';
  }

  function closeDialog() {
    document.getElementById('dialog-overlay').style.display = 'none';
  }

  // Initialize the player
  loadAlbumData();
</script>
